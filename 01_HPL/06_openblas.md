Run HPL with OpenBLAS
====================

OpenBLAS is a n open source library forked from gotoBLAS, a high performance math library developed by Kazushige Goto.

Goto's hand-tuned code would outperform the fastest code generated by commercial compilers.

Install OpenBLAS
OpenBLAS user manual
~~~
$ cd
$ git clone https://github.com/xianyi/OpenBLAS.git
$ cd OpenBLAS
$ make -j 8 USE_OPENMP=1
$ make PREFIX=$HOME/openblas install
$ ls $HOME/openblas
~~~

Test the BLAS DGEMM
Download test.c: https://gist.github.com/xianyi/5780018
~~~
$ cd $HOME/openblas
$ mkdir test
$ wget https://gist.githubusercontent.com/xianyi/5780018/raw/c1d93058a2f61b88b9dd4237d2cf4a963065070b/time_dgemm.c
~~~

Test static linking
~~~
$ gcc -o time_dgemm time_dgemm.c /root/openblas/lib/libopenblas.a -lpthread
$ echo $?
$ ./time_dgemm 1000 2000 4000
$ cat timeDGEMM.txt
~~~

Test dynamic linking
~~~
$ export LD_LIBRARY_PATH=/root/openblas/lib
$ gcc -o time_dgemm time_dgemm.c -I /root/openblas/include -L /root/openblas/lib/ -lopenblas  -lpthread
$ echo $?
$ ldd time_dgemm
$ ./time_dgemm 1000 2000 4000
$ cat timeDGEMM.txt
~~~

Test HPL with OpenBLAS

~~~
$ cd $HOME/hpl-2.3
$ cp Make.Linux_mpich_MKL Make.Linux_mpich_OpenBLAS
$ cat Make.Linux_mpich_OpenBLAS 
SHELL        = /bin/sh
CD           = cd
CP           = cp
LN_S         = ln -s
MKDIR        = mkdir
RM           = /bin/rm -f
TOUCH        = touch
ARCH         = Linux_mpich_OpenBLAS
TOPdir       = $(HOME)/hpl-2.3
INCdir       = $(TOPdir)/include
BINdir       = $(TOPdir)/bin/$(ARCH)
LIBdir       = $(TOPdir)/lib/$(ARCH)
HPLlib       = $(LIBdir)/libhpl.a
MPdir        = $(HOME)/mpich3-install
MPinc        = -I $(MPdir)/include
MPlib        = $(MPdir)/lib/libmpi.a
LAdir        = $(HOME)/openblas
LAinc        = $(LAdir)/include
LAlib        = -L $(LAdir)/lib -lopenblas  -lpthread
F2CDEFS      = -DAdd_ -DF77_INTEGER=int -DStringSunStyle
HPL_INCLUDES = -I$(INCdir) -I$(INCdir)/$(ARCH) $(LAinc) $(MPinc)
HPL_LIBS     = $(HPLlib) $(LAlib) $(MPlib)
HPL_OPTS     =
HPL_DEFS     = $(F2CDEFS) $(HPL_OPTS) $(HPL_INCLUDES)
CC           = mpicc
CCNOOPT      = $(HPL_DEFS)
CCFLAGS      = $(HPL_DEFS) -m64 -march=core-avx2 -lm -fomit-frame-pointer -O3 -funroll-loops 
LINKER       = mpif77
LINKFLAGS    = -lrt
ARCHIVER     = ar
ARFLAGS      = r
RANLIB       = echo

$ make arch=Linux_mpich_OpenBLAS
~~~

Run HPL with OpenBLAS

~~~
$ cd bin/Linux_mpich_OpenBLAS
$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/openblas/lib
$ ldd xhpl
$ cp ../Linux_mpich_MKL/HPL.dat .
$ cat HPL.dat
HPLinpack benchmark input file
Innovative Computing Laboratory, University of Tennessee
HPL.out      output file name (if any)
6            device out (6=stdout,7=stderr,file)
1            # of problems sizes (N)
116480 65536 Ns
1            # of NBs
164 128 64      NBs
0            PMAP process mapping (0=Row-,1=Column-major)
1            # of process grids (P x Q)
4            Ps
4            Qs
16.0         threshold
1            # of panel fact
2 1 2        PFACTs (0=left, 1=Crout, 2=Right)
1            # of recursive stopping criterium
2 4          NBMINs (>= 1)
1            # of panels in recursion
2            NDIVs
1            # of recursive panel fact.
0 1 2        RFACTs (0=left, 1=Crout, 2=Right)
1            # of broadcast
0            BCASTs (0=1rg,1=1rM,2=2rg,3=2rM,4=Lng,5=LnM)
1            # of lookahead depth
0            DEPTHs (>=0)
2            SWAP (0=bin-exch,1=long,2=mix)
64           swapping threshold
0            L1 in (0=transposed,1=no-transposed) form
0            U  in (0=transposed,1=no-transposed) form
1            Equilibration (0=no,1=yes)
8            memory alignment in double (> 0)
$  OMP_NUM_THREADS=1 mpiexec -f ~/machinefile ./xhpl
...
WR00L2R2      116480   164     2     8            3014.66             3.4949e+02

$ echo "scale=3; 349.49/537.6" | bc -l
.650
~~~
